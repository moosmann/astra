#! /usr/bin/env python
"""
Module for import of CT data stored in a Matlab file.

"""

import numpy as np
import os
import scipy.io

__metaclass__ = type

class Data:

    # def __init__(self, folder):
    #     self.folderName = folder

    name = 'Name_of_data_file_without_suffix'
    def set_name(self, name):
        self.name = name
        self.filename = self.parent_path + name + self.data_format

    data_format = '.mat'
    def set_data_format(self, data_format):
        self.data_format = data_format
        self.filename = self.parent_path + self.name +  data_format

    parent_path = os.getenv('HOME') + '/data/gate/'
    def set_parent_path(self, parent_path):
        self.parent_path = parent_path
        self.filename = parent_path + self.name + self.data_format

    fieldname = 'detector_astra'
    def set_fieldname(self, fieldname):
        self.fieldname = fieldname

    filename = parent_path + name + data_format
    def set_filename(self, filename):
        self.filename = filename
        root, self.data_format = os.path.splitext(filename)
        self.parent_path = os.path.dirname(filename)
        self.name = os.path.basename(root)
        
    geometry = ''
    def set_geometry(self, geometry):
        self.geometry = geometry

    angle_range__rad = -2 * np.pi
    def set_angle_range__rad(self, angle_range__rad):
        self.angle_range__rad = float(angle_range__rad)
        if self.angles__rad.any():
            self.angles__rad = self.angle_range__rad * np.arange(self.shape[1]) / self.shape[1]

    angles__rad = np.array([])

    # Distances between source, origin, and detector
    distance_source_origin__mm = 0
    def set_distance_source_origin__mm(self, distance_source_origin__mm):
        self.distance_source_origin__mm = float(distance_source_origin__mm)
        if not self.distance_source_detector__mm:
            self.distance_source_detector__mm = distance_source_origin__mm + self.distance_origin_detector__mm
        if not self.distance_origin_detector__mm:
            self.distance_origin_detector__mm = self.distance_source_detector__mm - distance_source_origin__mm

    distance_origin_detector__mm = 0
    def set_distance_origin_detector__mm(self, distance_origin_detector__mm):
        self.distance_origin_detector__mm = float(distance_origin_detector__mm)
        if not self.distance_source_detector__mm:
            self.distance_source_detector__mm = self.distance_source_origin__mm + distance_origin_detector__mm
        if not self.distance_source_origin__mm:
            self.distance_source_origin__mm = self.distance_source_detector__mm - distance_origin_detector__mm

    distance_source_detector__mm = 0
    def set_distance_source_detector__mm(self, distance_source_detector__mm):
        self.distance_source_detector__mm = float(distance_source_detector__mm)
        if not self.distance_origin_detector__mm:
            self.distance_origin_detector__mm = distance_source_detector__mm - self.distance_source_origin__mm
        if not self.distance_source_origin__mm:
            self.distance_source_origin__mm = distance_source_detector__mm - self.distance_origin_detector__mm


    detectorWidth_mm = 100
    def set_detector_width__mm(self, detector_width__mm):
        self.detector_width__mm = float(detector_width__mm)

    permute_order = (0, 1, 2)
    def set_permute_order(self, permute_order):
        self.permute_order = permute_order

    projections = np.array([])

    def load(self):
        if not self.projections.shape[0]:
            self.projections = np.transpose(scipy.io.loadmat(self.filename)[self.fieldname], self.permute_order)
            self.shape = self.projections.shape
            self.angles__rad = self.angle_range__rad * np.arange(self.shape[1]) / self.shape[1]
        return self.projections
        
        
""" Below follows the instantion of class Data for various data sets, largely 
conebeam geomatry and gate data.
"""


nn = 1;
data(nn).dir = data_dir ;
data(nn).filename = 'detector_two_spheres_Astra_20150313';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [3 2 1];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 280; 
data(nn).origin_det_mm = 20;
data(nn).detector_width_mm = 50;

nn = 2;
data(nn).dir = data_dir ;
data(nn).filename = '20150317_water_spheres_all_photons';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 280; 
data(nn).origin_det_mm = 20;
data(nn).detector_width_mm = 50;

nn = 3;
data(nn).dir = data_dir ;
data(nn).filename = '20150317_water_spheres_primary_photons';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 280; 
data(nn).origin_det_mm = 20;
data(nn).detector_width_mm = 50;

nn = 4;
data(nn).dir = data_dir ;
data(nn).filename = '20150317_water_spheres_all_photons_high_act';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 280; 
data(nn).origin_det_mm = 20;
data(nn).detector_width_mm = 50;

nn = 5;
data(nn).dir = data_dir ;
data(nn).filename = '20150320_central_water_spheres';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 190; 
data(nn).origin_det_mm = 110;
data(nn).detector_width_mm = 50;

nn = 6;
data(nn).dir = data_dir ;
data(nn).filename = '20150320_shifted_water_spheres';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 190; 
data(nn).origin_det_mm = 110;
data(nn).detector_width_mm = 50;

nn = 7;
data(nn).dir = data_dir ;
data(nn).filename = '20150324_water_spheres_larger_det';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 190; 
data(nn).origin_det_mm = 110;
data(nn).detector_width_mm = 100;

nn = 8;
data(nn).dir = data_dir ;
data(nn).filename = '20150330_voxelbox_30x30';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = - 2 * pi;
data(nn).source_origin_mm = 190; 
data(nn).origin_det_mm = 110;
data(nn).detector_width_mm = 100;

nn = 9;
data(nn).dir = data_dir ;
data(nn).filename = '20150410_water_spheres_high_act';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad =  - 2 * pi;
data(nn).source_origin_mm = 190; 
data(nn).origin_det_mm = 110;
data(nn).detector_width_mm = 100;

nn = 10;
data(nn).dir = [ getenv('HOME') '/data/matlab/'];
data(nn).filename = 'conebeam_2balls_h100_p360_v100';
data(nn).fieldname = 'proj_data';
data(nn).permuteOrder = [1 2 3];
data(nn).fullAngle_rad = 2 * pi;
data(nn).source_origin_mm = 190; 
data(nn).origin_det_mm = 110;
data(nn).detector_width_mm = 100;

nn = 11;
data(nn).dir = [ getenv('HOME') '/data/gate/'];
data(nn).filename = '20150525_CBCT_skull';
data(nn).fieldname = 'detector_astra';
data(nn).permuteOrder = [3 2 1];
data(nn).fullAngle_rad = -2 * pi;
data(nn).source_origin_mm = 1085.6 - 490.6; 
data(nn).origin_det_mm = 490.6;
data(nn).detector_width_mm = 500;















set1 = Data()
set1.set_name('20150528_CBCT_skull')
set1.set_fieldname('detector_astra_full')
set1.set_angle_range__rad(-2*np.pi)
set1.set_distance_source_detector__mm(1085.6)
set1.set_distance_origin_detector__mm(490.6)









# set1.load()

if 0:
    print set1.distance_source_origin__mm, set1.distance_origin_detector__mm, set1.distance_source_detector__mm
    set1.set_distance_source_detector__mm(1085.6)
    print set1.distance_source_origin__mm, set1.distance_origin_detector__mm, set1.distance_source_detector__mm
    set1.set_distance_origin_detector__mm(490.6)
    print set1.distance_source_origin__mm, set1.distance_origin_detector__mm, set1.distance_source_detector__mm

if 0:
    d = Data()
    d.set_name('detector_two_spheres_Astra_20150313')
    fn = d.filename
    d.load()
    d.set_distance_source_origin__mm(44)
    d.set_distance_origin_detector__mm(55)
    d.set_filename('/root/name/dataSetName.extension')
    
    print d.distance_source_detector__mm
    print d.shape
    print d.parent_path + d.name + d.data_format
    
    print d.angle_range__rad
    d.set_angle_range__rad(1)
    print d.angles__rad[-1]
